{% extends "standard-form.njk" %}
{% from "radios/macro.njk" import govukRadios %}
{% from "input/macro.njk" import govukInput %}
{% from "warning-text/macro.njk" import govukWarningText %}

{% set title = mssgs.important_info_contact_title_you if data.isLicenceForYou else mssgs.important_info_contact_title_other %}
{% set errorMsg = mssgs.important_info_contact_error_choose %}
{% set emailError = mssgs.important_info_contact_error_email %}
{% set mobileError = mssgs.important_info_contact_error_mobile %}

{% set errorMap = {
        'how-contacted': {
            'any.required': { ref: '#how-contacted', text: errorMsg }
        },
        'email': {
            'string.empty': { ref: '#email', text: emailError },
            'string.email': { ref: '#email', text: emailError },
            'string.max': { ref: '#email', text: emailError }
        },
        'text': {
            'string.empty': { ref: '#text', text: mobileError },
            'string.pattern.base': { ref: '#text', text: mobileError },
            'string.max': { ref: '#text', text: mobileError }
        }
    }
%}

{% block pageTitle %}{{ title }}{{ mssgs.gov_uk }}{% endblock %}

{% set emailHtml %}
    <div id="email-rw" class="govuk-body-m">
        {{ govukInput({
          id: "email",
          name: "email",
          type: "email",
          classes: "govuk-!-width-two-thirds",
          autocomplete: "email",
          errorMessage: { text: mssgs.important_info_contact_error_email } if error['email'],
          label: {
            text: mssgs.important_info_contact_input_email
          },
          hint: {
              text: mssgs.important_info_contact_input_email_hint
          },
          attributes: {
            spellcheck: "false",
            maxlength: "50"
          },
          value: data.licensee.email if (data.licensee.email and not error['email']) else payload.email
        }) }}
    </div>
    <div id="email-ro" class="govuk-body-m initially-hidden">
        {{ mssgs.important_info_contact_input_email }}</br>
        <span class="govuk-body-m govuk-!-font-weight-bold">{{ data.licensee.email }}
        </span>
    </div>
{% endset -%}

{% set textMessageHtml %}
    <div id="text-rw" class="govuk-body-m">
        {{ govukInput({
          id: "text",
          name: "text",
          type: "tel",
          autocomplete: "tel",
          classes: "govuk-!-width-one-third",
          errorMessage: { text: mssgs.important_info_contact_error_mobile } if error['text'],
          label: {
            text: mssgs.important_info_contact_input_mobile
          },
          hint: {
              text: mssgs.important_info_contact_input_mobile_hint
          },
          attributes: {
            maxlength: "16"
          },
          value: data.licensee.mobilePhone if (data.licensee.mobilePhone and not error['text']) else payload.text
        }) }}
     </div>
     <div id="text-ro" class="govuk-body-m initially-hidden">
         {{ mssgs.important_info_contact_input_mobile_note }}</br>
         <span class="govuk-body-m govuk-!-font-weight-bold">{{ data.licensee.mobilePhone }}
         </span>
     </div>
{% endset -%}

{% set postMessageHtml %}
    <p class="govuk-body-m">{{ mssgs.important_info_contact_post_msg }}</p>
{% endset -%}

{% set noneMessageHtml %}
    <p class="govuk-body-m">{{ mssgs.important_info_contact_none_msg }}</p>
{% endset -%}

{% set itemsArray = [] %}
{% if data.licensee.email %}
    {% set itemsArray = (itemsArray.push(
        {
            value: "email",
            text: mssgs.important_info_contact_item_email ~ data.licensee.email,
            checked: payload['how-contacted'] === 'email'
        }), itemsArray)
    %}
{% else %}
    {% set itemsArray = (itemsArray.push(
        {
            value: "email",
            text: mssgs.important_info_contact_item_email,
            checked: payload['how-contacted'] === 'email',
            conditional: {
                html: emailHtml
            }
        }), itemsArray)
    %}
{% endif %}

{% if data.licensee.mobilePhone %}
    {% set itemsArray = (itemsArray.push(
        {
            value: "text",
            text: mssgs.important_info_contact_item_txt_value ~ data.licensee.mobilePhone,
            checked: payload['how-contacted'] === 'text'
        }), itemsArray)
    %}
{% else %}
    {% set itemsArray = (itemsArray.push(
        {
            value: "text",
            text: mssgs.important_info_contact_item_txt,
            checked: payload['how-contacted'] === 'text',
            conditional: {
                html: textMessageHtml
            }
        }), itemsArray)
    %}
{% endif %}

{% if data.isPhysical %}
    {% if data.licensee.postalFulfilment %}
        {% if data.isLicenceForYou %}
            {% set itemsArray = (itemsArray.push(
                {
                    value: "none",
                    text: mssgs.important_info_contact_post,
                    checked: payload['how-contacted'] === 'post',
                    hint: {
                        text: mssgs.important_info_contact_post_hint_you
                    }
                }), itemsArray)
            %}
        {% else %}
            {% set itemsArray = (itemsArray.push(
                {
                    value: "none",
                    text: mssgs.important_info_contact_post,
                    checked: payload['how-contacted'] === 'post',
                    hint: {
                        text: mssgs.important_info_contact_post_hint_other
                    }
                }), itemsArray)
            %}
        {% endif %}
    {% endif %}
{% else %}
    {% set itemsArray = (itemsArray.push(
        {
            value: "none",
            text: mssgs.important_info_contact_note_tip,
            checked: payload['how-contacted'] === 'none',
            conditional: {
                html: noneMessageHtml
            }
        }), itemsArray)
    %}
{% endif %}

{% block pageContent %}
    {% if data.isPhysical %}
        {% if data.isLicenceForYou %}
            {% if data.licensee.isSalmon %}
                <p class="govuk-body-m">{{ mssgs.important_info_contact_post_salmon_you }}</p>
            {% else %}
                <p class="govuk-body-m">{{ mssgs.important_info_contact_post_not_salmon_you }}</p>
            {% endif %}
        {% else %}
            {% if data.licensee.isSalmon %}
                <p class="govuk-body-m">{{ mssgs.important_info_contact_post_salmon_other }}</p>
            {% else %}
                <p class="govuk-body-m">{{ mssgs.important_info_contact_post_not_salmon_other }}</p>
            {% endif %}
        {% endif %}
    {% else %}
        {% if data.isJunior %}
            <p class="govuk-body-m">{{ mssgs.important_info_contact_post_confirm_jr }}</p>
            <p class="govuk-body-m">{{ mssgs.important_info_contact_licence_needed }}</p>
        {% else %}
            <p class="govuk-body-m">{{ mssgs.important_info_contact_post_confirm_8d }}</p>
            <p class="govuk-body-m">{{ mssgs.important_info_contact_licence_needed }}</p>
        {% endif %}
    {% endif %}

    {{ govukRadios({
      idPrefix: "how-contacted",
      name: "how-contacted",
      errorMessage: { text: errorMsg } if error['how-contacted'],
      items: itemsArray
    }) }}

{% endblock %}

{% block bodyEnd %}
    <script src="/public/javascript/all-min.js"></script>
    <script nonce={{nonce}}>window.GOVUKFrontend.initAll()</script>
    <script nonce={{nonce}}>(function () {
        if (('{{ data.licensee.email }}') && !'{{ error.email }}' ) {
            document.getElementById("email-ro").style.display = "block"
            document.getElementById("email-rw").style.display = "none"
        } else {
            document.getElementById("email-ro").style.display = "none"
            document.getElementById("email-rw").style.display = "block"
        }
        document.getElementById("change-email").addEventListener("click", function () {
            document.getElementById("email-ro").style.display = "none"
            document.getElementById("email-rw").style.display = "block"
        })
    })()</script>
    <script nonce={{nonce}}>(function () {
        if (('{{ data.licensee.mobilePhone }}') && !'{{ error.text }}' ) {
            document.getElementById("text-ro").style.display = "block"
            document.getElementById("text-rw").style.display = "none"
        } else {
            document.getElementById("text-ro").style.display = "none"
            document.getElementById("text-rw").style.display = "block"
        }
        document.getElementById("change-text").addEventListener("click", function () {
            document.getElementById("text-ro").style.display = "none"
            document.getElementById("text-rw").style.display = "block"
        })
    })()</script>
{% endblock %}
